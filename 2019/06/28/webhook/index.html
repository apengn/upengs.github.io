<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Kubernetes中的Admission Controller是做什么的呢？有什么用呢？怎么自己定义一个呢？Q: 什么是Admission Controller?A: 官方定义： An admission controller is a piece of code that intercepts requests to the Kubernetes API server prior to per">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes webhook">
<meta property="og:url" content="http://yoursite.com/2019/06/28/webhook/index.html">
<meta property="og:site_name" content="Peng">
<meta property="og:description" content="Kubernetes中的Admission Controller是做什么的呢？有什么用呢？怎么自己定义一个呢？Q: 什么是Admission Controller?A: 官方定义： An admission controller is a piece of code that intercepts requests to the Kubernetes API server prior to per">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-06-28T08:07:19.042Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kubernetes webhook">
<meta name="twitter:description" content="Kubernetes中的Admission Controller是做什么的呢？有什么用呢？怎么自己定义一个呢？Q: 什么是Admission Controller?A: 官方定义： An admission controller is a piece of code that intercepts requests to the Kubernetes API server prior to per">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/06/28/webhook/">





  <title>kubernetes webhook | Peng</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Peng</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Welcome to my Blogs!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/28/webhook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pengemailcom@163.com">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Peng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">kubernetes webhook</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-28T14:39:47+08:00">
                2019-06-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Kubernetes中的Admission-Controller是做什么的呢？有什么用呢？怎么自己定义一个呢？"><a href="#Kubernetes中的Admission-Controller是做什么的呢？有什么用呢？怎么自己定义一个呢？" class="headerlink" title="Kubernetes中的Admission Controller是做什么的呢？有什么用呢？怎么自己定义一个呢？"></a>Kubernetes中的Admission Controller是做什么的呢？有什么用呢？怎么自己定义一个呢？</h1><h2 id="Q-什么是Admission-Controller"><a href="#Q-什么是Admission-Controller" class="headerlink" title="Q: 什么是Admission Controller?"></a>Q: 什么是Admission Controller?</h2><p>A: 官方定义：</p>
<p>An admission controller is a piece of code that intercepts requests to the Kubernetes API server prior to persistence of the object, but after the request is authenticated and authorized.</p>
<p>我理解的：</p>
<p>Admission Controller是一个拦截器<br>拦截发送给Kuberenetes API Server的请求<br>什么时候拦截？在请求通过认证之后，请求被存储起来之前</p>
<p>所以顺理成章，由于拦截的是发送给API Server的请求，所以Admission Controller存在于API Server内部，即compiled into the kube-apiserver binary（被编译进API Server的可执行文件里）。<br>kubernetes将AC分为三种：</p>
<p>validating，验证型。用于验证k8s的资源定义是否符合规则<br>mutating，修改型。用于修改k8s的资源定义，比如加个label什么的<br>二者皆是，即同一个AC，既是验证型又是修改型</p>
<p>多个Admission Controller会形成一个Admission Chain（链条），修改型的在前面先执行，验证型的在后面后执行，这样验证型的才能去验证修改的对不对。<br>K: interceptor, validating, mutating, Admission Chain<br>Q: Admission Controller有什么用？<br>A: API Server内置了一些AC，有各种各样的作用[1]。比如：</p>
<p>EventRateLimit，用于限制事件的频率<br>LimitRanger，验证所有的请求都没有超出namespace中定义的LimitRange</p>
<p>还有很多其他AC，具体请参考Kubernetes文档。<br>这些AC中，有两个对用户来说比较有用：</p>
<p>MutatingAdmissionWebhook，这是一个webhook，即网络钩子，也就是说该AC会去请求服务端，并执行相应的逻辑<br>ValidatingAdmissionWebhook，也是一个webhook，只是用于验证</p>
<p>Q: 怎么查看哪些AC是打开了的？<br>A: 文档上写的用：kube-apiserver -h | grep enable-admission-plugins。但是由于本地是minikube，进入虚拟机之后并没有发现kube-apiserver命令。<br>后来发现api-server是以pod的形式运行的：<br>kubectl get pods -n kube-system</p>
<p>于是，使用kubectl exec登入pod，然后调用上述的指令，其结果为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kube-apiserver -h | grep enable-admission-plugins</span><br><span class="line">      --admission-control strings              Admission is divided into two phases. In the first phase, only mutating admission plugins run. In the second phase, only validating admission plugins run. The names in the below list may represent a validating plugin, a mutating plugin, or both. The order of plugins in which they are passed to this flag does not matter. Comma-delimited list of: AlwaysAdmit, AlwaysDeny, AlwaysPullImages, DefaultStorageClass, DefaultTolerationSeconds, DenyEscalatingExec, DenyExecOnPrivileged, EventRateLimit, ExtendedResourceToleration, ImagePolicyWebhook, Initializers, LimitPodHardAntiAffinityTopology, LimitRanger, MutatingAdmissionWebhook, NamespaceAutoProvision, NamespaceExists, NamespaceLifecycle, NodeRestriction, OwnerReferencesPermissionEnforcement, PersistentVolumeClaimResize, PersistentVolumeLabel, PodNodeSelector, PodPreset, PodSecurityPolicy, PodTolerationRestriction, Priority, ResourceQuota, SecurityContextDeny, ServiceAccount, StorageObjectInUseProtection, ValidatingAdmissionWebhook. (DEPRECATED: Use --enable-admission-plugins or --disable-admission-plugins instead. Will be removed in a future version.)</span><br><span class="line">      --enable-admission-plugins strings       admission plugins that should be enabled in addition to default enabled ones (NamespaceLifecycle, LimitRanger, ServiceAccount, Priority, DefaultTolerationSeconds, DefaultStorageClass, PersistentVolumeClaimResize, MutatingAdmissionWebhook, ValidatingAdmissionWebhook, ResourceQuota). Comma-delimited list of admission plugins: AlwaysAdmit, AlwaysDeny, AlwaysPullImages, DefaultStorageClass, DefaultTolerationSeconds, DenyEscalatingExec, DenyExecOnPrivileged, EventRateLimit, ExtendedResourceToleration, ImagePolicyWebhook, Initializers, LimitPodHardAntiAffinityTopology, LimitRanger, MutatingAdmissionWebhook, NamespaceAutoProvision, NamespaceExists, NamespaceLifecycle, NodeRestriction, OwnerReferencesPermissionEnforcement, PersistentVolumeClaimResize, PersistentVolumeLabel, PodNodeSelector, PodPreset, PodSecurityPolicy, PodTolerationRestriction, Priority, ResourceQuota, SecurityContextDeny, ServiceAccount, StorageObjectInUseProtection, ValidatingAdmissionWebhook. The order of plugins in this flag does not matter.</span><br></pre></td></tr></table></figure></p>
<h2 id="Q-Admission-webhook是啥？"><a href="#Q-Admission-webhook是啥？" class="headerlink" title="Q: Admission webhook是啥？"></a>Q: Admission webhook是啥？</h2><p>A: 官方定义：</p>
<p>Admission webhooks are HTTP callbacks that receive admission requests and do something with them.</p>
<p>简单来说webhook就是一个HTTP回调，接收admission请求，处理并返回。<br>用户可以定义两种webhook:</p>
<p>validating admission webhook<br>mutating admission webhook<br>一个用于验证，另一个用于修改。<br>webhook回调，接收API Server发送的admissionReview请求，并返回 admissionResponse。</p>
<p>K: 回调，admissionReview请求，admissionResponse返回。<br>Q: 如何配置和查看WebhookConfiguration?<br>A: 以Validating为例，查看：<br>kubectl get ValidatingWebhookConfiguration</p>
<h3 id="ValidatingWebhookConfiguration的资源定义："><a href="#ValidatingWebhookConfiguration的资源定义：" class="headerlink" title="ValidatingWebhookConfiguration的资源定义："></a>ValidatingWebhookConfiguration的资源定义：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: admissionregistration.k8s.io/v1beta1</span><br><span class="line">kind: ValidatingWebhookConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  name: &lt;name of this configuration object&gt;</span><br><span class="line">webhooks:</span><br><span class="line">- name: &lt;webhook name, e.g., pod-policy.example.io&gt;</span><br><span class="line">  rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">    - &quot;&quot;</span><br><span class="line">    apiVersions:</span><br><span class="line">    - v1</span><br><span class="line">    operations:</span><br><span class="line">    - CREATE</span><br><span class="line">    resources:</span><br><span class="line">    - pods</span><br><span class="line">  clientConfig:</span><br><span class="line">    service:</span><br><span class="line">      namespace: &lt;namespace of the front-end service&gt;</span><br><span class="line">      name: &lt;name of the front-end service&gt;</span><br><span class="line">    caBundle: &lt;pem encoded ca cert that signs the server cert used by the webhook&gt;</span><br></pre></td></tr></table></figure>
<h3 id="其中rules定义了匹配规则，当发给API-Server的请求满足该规则的时候，API-Server就会给clientConfig中配置的service发送Admission请求。"><a href="#其中rules定义了匹配规则，当发给API-Server的请求满足该规则的时候，API-Server就会给clientConfig中配置的service发送Admission请求。" class="headerlink" title="其中rules定义了匹配规则，当发给API Server的请求满足该规则的时候，API Server就会给clientConfig中配置的service发送Admission请求。"></a>其中rules定义了匹配规则，当发给API Server的请求满足该规则的时候，API Server就会给clientConfig中配置的service发送Admission请求。</h3><p>使用webhook有什么要求？<br>A: 几点：</p>
<p>kubernetes版本最低是v1.9<br>api server使能（enable）了MutatingAdmissionWebhook和ValidatingAdmissionWebhook<br>admissionregistration.k8s.io/v1beta1 API处于enable状态，即使用kubectl api-versions | grep admissionregistration.k8s.io/v1beta1</p>
<p>###Q: 如何自己写一个webhook?</p>
<h3 id="A-需要完成几个事情："><a href="#A-需要完成几个事情：" class="headerlink" title="A: 需要完成几个事情："></a>A: 需要完成几个事情：</h3><p>创建TLS Certificate，即证书<br>编写服务端代码，服务端代码需要使用证书<br>根据证书创建k8s sercret<br>创建k8s Deployment和Service<br>创建k8s WebhookConfiguration，其中需要使用之前创建的证书</p>
<p>具体代码和流程参见[3]［4］<br>参考文献：<br>[1] <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/</a><br>[2] <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#admission-webhooks" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#admission-webhooks</a><br>[3] <a href="https://banzaicloud.com/blog/k8s-admission-webhooks/" target="_blank" rel="noopener">https://banzaicloud.com/blog/k8s-admission-webhooks/</a><br>[4] <a href="https://github.com/morvencao/kube-mutating-webhook-tutorial" target="_blank" rel="noopener">https://github.com/morvencao/kube-mutating-webhook-tutorial</a><br>[5] <a href="https://github.com/banzaicloud/admission-webhook-example" target="_blank" rel="noopener">https://github.com/banzaicloud/admission-webhook-example</a></p>
<p>作者：Mr_Hospital<br>链接：<a href="https://www.jianshu.com/p/39ae0b6fc907" target="_blank" rel="noopener">https://www.jianshu.com/p/39ae0b6fc907</a><br>来源：简书<br>简书著作权归作者所有，任何形式的转载都请联系作者获得授权并注明出处。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/27/golang-ca/" rel="next" title="golang-ca">
                <i class="fa fa-chevron-left"></i> golang-ca
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/28/golang/" rel="prev" title="golang">
                golang <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">pengemailcom@163.com</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes中的Admission-Controller是做什么的呢？有什么用呢？怎么自己定义一个呢？"><span class="nav-number">1.</span> <span class="nav-text">Kubernetes中的Admission Controller是做什么的呢？有什么用呢？怎么自己定义一个呢？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Q-什么是Admission-Controller"><span class="nav-number">1.1.</span> <span class="nav-text">Q: 什么是Admission Controller?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q-Admission-webhook是啥？"><span class="nav-number">1.2.</span> <span class="nav-text">Q: Admission webhook是啥？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ValidatingWebhookConfiguration的资源定义："><span class="nav-number">1.2.1.</span> <span class="nav-text">ValidatingWebhookConfiguration的资源定义：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其中rules定义了匹配规则，当发给API-Server的请求满足该规则的时候，API-Server就会给clientConfig中配置的service发送Admission请求。"><span class="nav-number">1.2.2.</span> <span class="nav-text">其中rules定义了匹配规则，当发给API Server的请求满足该规则的时候，API Server就会给clientConfig中配置的service发送Admission请求。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A-需要完成几个事情："><span class="nav-number">1.2.3.</span> <span class="nav-text">A: 需要完成几个事情：</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pengemailcom@163.com</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
